<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Iframe Fit to Content | Personal Archive</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="">
<meta name="generator" content="Hugo 0.82.0" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />





  
    <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Personal Archive" />
    <link href="/index.xml" rel="feed" type="application/rss+xml" title="Personal Archive" />
  




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Iframe Fit to Content</h1>

    <div class="tip">
        <span>
          Apr 1, 2021 10:27
        </span>
        <span class="split">
          ·
        </span>
        <span>
          
            385 words
          
        </span>
        <span class="split">
          ·
        </span>
        <span>
          2 minute read
        </span>
    </div>

    <div class="content">
      <h1 id="根据iframe的内容调整其大小">根据iframe的内容调整其大小 <a href="#%e6%a0%b9%e6%8d%aeiframe%e7%9a%84%e5%86%85%e5%ae%b9%e8%b0%83%e6%95%b4%e5%85%b6%e5%a4%a7%e5%b0%8f" class="anchor">🔗</a></h1><p>在做邮件预览的功能时，需要将邮件的HTML内容显示出来。一开始的做法是sanitized之后直接渲染出来。但是CSS样式要尽量保留，结果就是这些样式连外面不属于邮件的部分也影响了。</p>
<p>于是把邮件的内容放到一个iframe里面去，隔离它的样式。而iframe一般要写死高度和宽度，这样如果邮件内容过长过宽，就会出现滚动条。理想的情况是根据iframe的内容调整其大小。</p>
<p>这里记录一下我是怎么做的，直接上代码：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vue" data-lang="vue">&lt;<span style="color:#062873;font-weight:bold">template</span>&gt;
  &lt;<span style="color:#062873;font-weight:bold">iframe</span>
    <span style="color:#062873;font-weight:bold">:id</span><span style="color:#4070a0">=&#34;iframe_id&#34;</span>
    <span style="color:#062873;font-weight:bold">:src</span><span style="color:#4070a0">=&#34;iframe.src&#34;</span>
    <span style="color:#062873;font-weight:bold">:style</span><span style="color:#4070a0">=&#34;iframe.style&#34;</span>
    <span style="color:#062873;font-weight:bold">@load</span><span style="color:#4070a0">=&#34;onIframeLoaded&#34;</span>
    &gt;
  &lt;/<span style="color:#062873;font-weight:bold">iframe</span>&gt;
&lt;/<span style="color:#062873;font-weight:bold">template</span>&gt;

&lt;<span style="color:#062873;font-weight:bold">script</span>&gt;
  <span style="color:#007020;font-weight:bold">import</span> HtmlSanitizer from <span style="color:#4070a0">&#39;@/assets/HtmlSanitizer.js&#39;</span>
  <span style="color:#007020;font-weight:bold">export</span> <span style="color:#007020;font-weight:bold">default</span> {
    name<span style="color:#666">:</span> <span style="color:#4070a0">&#34;vue-iframe&#34;</span>,
    data() {
      <span style="color:#007020;font-weight:bold">return</span> {
        iframe<span style="color:#666">:</span> {
          src<span style="color:#666">:</span> <span style="color:#4070a0">&#39;&#39;</span>,
          style<span style="color:#666">:</span> {}
        },
        bloburl<span style="color:#666">:</span> <span style="color:#4070a0">&#39;&#39;</span>
      }
    },
    props<span style="color:#666">:</span> {
      id<span style="color:#666">:</span> {<span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span> <span style="color:#4070a0">&#39;default&#39;</span>},
      raw_html<span style="color:#666">:</span> {<span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span> <span style="color:#4070a0">&#39;&#39;</span>},
      url<span style="color:#666">:</span> {<span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span> <span style="color:#4070a0">&#39;&#39;</span>},
      height<span style="color:#666">:</span> {<span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span> <span style="color:#4070a0">&#39;&#39;</span>},
      width<span style="color:#666">:</span> {<span style="color:#007020;font-weight:bold">default</span><span style="color:#666">:</span> <span style="color:#4070a0">&#39;100%&#39;</span>},
      innerStyle<span style="color:#666">:</span> {type<span style="color:#666">:</span> <span style="color:#007020">String</span>}
    },
    computed<span style="color:#666">:</span> {
      iframe_id<span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">function</span>() {
        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#39;iframe-&#39;</span> <span style="color:#666">+</span> <span style="color:#007020;font-weight:bold">this</span>.id <span style="color:#666">+</span> <span style="color:#4070a0">&#39;-&#39;</span> <span style="color:#666">+</span> <span style="color:#007020">Math</span>.floor(<span style="color:#007020">Math</span>.random() <span style="color:#666">*</span> <span style="color:#40a070">10</span>E8)
      },
      isHeightSet<span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">function</span>() {
        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#666">!!</span><span style="color:#007020;font-weight:bold">this</span>.height <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!!</span><span style="color:#007020;font-weight:bold">this</span>.height.length
      },
      <span style="color:#60a0b0;font-style:italic">// 判断传进来的url是否同源
</span><span style="color:#60a0b0;font-style:italic"></span>      isSameOrigin<span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">function</span>() {
        <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#666">!</span><span style="color:#007020;font-weight:bold">this</span>.url <span style="color:#666">||</span> <span style="color:#666">!</span><span style="color:#007020;font-weight:bold">this</span>.url.length) {
          <span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">true</span>
        }
        <span style="color:#007020;font-weight:bold">let</span> loc <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> URL(<span style="color:#007020">window</span>.location.href)
        <span style="color:#007020;font-weight:bold">let</span> url <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> URL(<span style="color:#007020;font-weight:bold">this</span>.url)
        <span style="color:#007020;font-weight:bold">return</span> loc.origin <span style="color:#666">===</span> url.origin
      }
    },
    watch<span style="color:#666">:</span> {
      raw_html<span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">function</span>(val, oldVal) {
        <span style="color:#007020;font-weight:bold">this</span>.initIframe()
      },
      url<span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">function</span>(val, oldVal) {
        <span style="color:#007020;font-weight:bold">this</span>.initIframe()
      }
    },
    methods<span style="color:#666">:</span> {
      initIframe() {
        <span style="color:#007020;font-weight:bold">this</span>.iframe.style.height <span style="color:#666">=</span> <span style="color:#4070a0">&#39;0&#39;</span>  <span style="color:#60a0b0;font-style:italic">// 重置iframe高度，否则iframe不会缩小
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#007020;font-weight:bold">this</span>.url <span style="color:#666">&amp;&amp;</span> <span style="color:#007020;font-weight:bold">this</span>.url.length) {
          <span style="color:#007020;font-weight:bold">this</span>.setIframeUrl(<span style="color:#007020;font-weight:bold">this</span>.url)
        }
        <span style="color:#007020;font-weight:bold">else</span> {
          <span style="color:#007020;font-weight:bold">let</span> html <span style="color:#666">=</span> HtmlSanitizer.SanitizeHtml(<span style="color:#007020;font-weight:bold">this</span>.raw_html)
          <span style="color:#007020;font-weight:bold">this</span>.setIframeContent(html)
        }
      },
      setIframeUrl(url) {
        <span style="color:#007020;font-weight:bold">this</span>.iframe.src <span style="color:#666">=</span> url
      },
      setIframeContent(content) {
        <span style="color:#007020;font-weight:bold">let</span> ua <span style="color:#666">=</span> <span style="color:#007020">window</span>.navigator.userAgent
        <span style="color:#007020;font-weight:bold">if</span> (ua.indexOf(<span style="color:#4070a0">&#39;Trident/&#39;</span>) <span style="color:#666">&gt;</span> <span style="color:#666">-</span><span style="color:#40a070">1</span>) {  <span style="color:#60a0b0;font-style:italic">// IE
</span><span style="color:#60a0b0;font-style:italic"></span>          <span style="color:#007020;font-weight:bold">let</span> doc <span style="color:#666">=</span> <span style="color:#007020">document</span>.getElementById(<span style="color:#007020;font-weight:bold">this</span>.iframe_id).contentWindow.<span style="color:#007020">document</span>
          doc.open().write(content)
          doc.close()
        }
        <span style="color:#007020;font-weight:bold">else</span> {
          <span style="color:#007020">window</span>.URL.revokeObjectURL(<span style="color:#007020;font-weight:bold">this</span>.bloburl)
          <span style="color:#007020;font-weight:bold">let</span> blob <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Blob([<span style="color:#4070a0">&#39;\uFEFF&#39;</span>, content], {type<span style="color:#666">:</span> <span style="color:#4070a0">&#39;text/html&#39;</span>})
          <span style="color:#007020;font-weight:bold">this</span>.bloburl <span style="color:#666">=</span> <span style="color:#007020">window</span>.URL.createObjectURL(blob)
          <span style="color:#007020;font-weight:bold">this</span>.iframe.src <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span>.bloburl
        }
      },
      onIframeLoaded() {
        <span style="color:#007020;font-weight:bold">this</span>.setDocStyle()
        <span style="color:#007020;font-weight:bold">this</span>.setIframeHeight()
        <span style="color:#007020;font-weight:bold">this</span>.$emit(<span style="color:#4070a0">&#39;loaded&#39;</span>, <span style="color:#007020;font-weight:bold">this</span>.iframe.style.height)
      },
      setIframeHeight() {
        <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#007020;font-weight:bold">this</span>.isHeightSet) {
          <span style="color:#007020;font-weight:bold">this</span>.iframe.style.height <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span>.height
        }
        <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#007020;font-weight:bold">this</span>.isSameOrigin) {
          <span style="color:#007020;font-weight:bold">let</span> doc <span style="color:#666">=</span> <span style="color:#007020">document</span>.getElementById(<span style="color:#007020;font-weight:bold">this</span>.iframe_id).contentWindow.<span style="color:#007020">document</span>
          <span style="color:#007020;font-weight:bold">let</span> height <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">this</span>.getDocHeight(doc)
          <span style="color:#007020;font-weight:bold">if</span> (height <span style="color:#666">===</span> <span style="color:#40a070">0</span>) {  <span style="color:#60a0b0;font-style:italic">// 有时高度会计算错误
</span><span style="color:#60a0b0;font-style:italic"></span>            height <span style="color:#666">=</span> <span style="color:#40a070">40</span>
          }
          <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> (doc.body <span style="color:#666">&amp;&amp;</span> doc.body.clientWidth <span style="color:#666">&lt;</span> doc.body.scrollWidth) {
            height <span style="color:#666">+=</span> <span style="color:#40a070">17</span>  <span style="color:#60a0b0;font-style:italic">// 滚动条的高度
</span><span style="color:#60a0b0;font-style:italic"></span>          }
          <span style="color:#007020;font-weight:bold">this</span>.iframe.style.height <span style="color:#666">=</span> height <span style="color:#666">+</span> <span style="color:#4070a0">&#39;px&#39;</span>
        }
        <span style="color:#007020;font-weight:bold">else</span> {
          <span style="color:#007020;font-weight:bold">this</span>.iframe.style.height <span style="color:#666">=</span> <span style="color:#4070a0">&#39;100%&#39;</span>
        }
        <span style="color:#60a0b0;font-style:italic">// this.$el.scrollIntoView({behavior: &#39;smooth&#39;, block: &#39;nearest&#39;, inline: &#39;start&#39;})
</span><span style="color:#60a0b0;font-style:italic"></span>      },
      getDocHeight(doc) {
        doc <span style="color:#666">=</span> doc <span style="color:#666">||</span> <span style="color:#007020">document</span>
        <span style="color:#007020;font-weight:bold">let</span> body <span style="color:#666">=</span> doc.body
        <span style="color:#007020;font-weight:bold">let</span> html <span style="color:#666">=</span> doc.documentElement
        <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#666">!</span>body <span style="color:#666">||</span> <span style="color:#666">!</span>html) <span style="color:#007020;font-weight:bold">return</span> <span style="color:#40a070">0</span>
        <span style="color:#007020;font-weight:bold">let</span> height <span style="color:#666">=</span> <span style="color:#007020">Math</span>.max(body.scrollHeight, body.offsetHeight,
                              html.clientHeight, html.scrollHeight, html.offsetHeight)
        <span style="color:#007020;font-weight:bold">return</span> height
      },
      <span style="color:#60a0b0;font-style:italic">// 设置iframe内容的基本样式
</span><span style="color:#60a0b0;font-style:italic"></span>      setDocStyle() {
        <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#007020;font-weight:bold">this</span>.isSameOrigin) {
          <span style="color:#007020;font-weight:bold">let</span> doc <span style="color:#666">=</span> <span style="color:#007020">document</span>.getElementById(<span style="color:#007020;font-weight:bold">this</span>.iframe_id).contentWindow.<span style="color:#007020">document</span>
          <span style="color:#007020;font-weight:bold">if</span> (doc) {
            doc.body.style.margin <span style="color:#666">=</span> <span style="color:#4070a0">&#39;0&#39;</span>
            doc.body.style.backgroundColor <span style="color:#666">=</span> <span style="color:#4070a0">&#39;transparent&#39;</span>
            <span style="color:#007020;font-weight:bold">let</span> css <span style="color:#666">=</span> <span style="color:#4070a0">&#39;body {font-family: Calibri, Arial, Helvetica, Hiragino Sans GB, Microsoft YaHei, sans-serif; font-size: 14px;}&#39;</span>
            <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#007020;font-weight:bold">this</span>.innerStyle) css <span style="color:#666">+=</span> <span style="color:#007020;font-weight:bold">this</span>.innerStyle
            <span style="color:#007020;font-weight:bold">let</span> style <span style="color:#666">=</span> <span style="color:#007020">document</span>.createElement(<span style="color:#4070a0">&#39;style&#39;</span>)
            style.appendChild(<span style="color:#007020">document</span>.createTextNode(css))
            doc.head.insertBefore(style, doc.head.firstChild)
          }
        }
      }
    },
    created() {
      <span style="color:#007020;font-weight:bold">this</span>.iframe.style <span style="color:#666">=</span> {
        position<span style="color:#666">:</span> <span style="color:#4070a0">&#39;relative&#39;</span>,
        height<span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">this</span>.height,
        width<span style="color:#666">:</span> <span style="color:#007020;font-weight:bold">this</span>.width,
        border<span style="color:#666">:</span> <span style="color:#40a070">0</span>
      }
    },
    mounted() {
      <span style="color:#007020;font-weight:bold">this</span>.initIframe()
    }
  }
&lt;/<span style="color:#062873;font-weight:bold">script</span>&gt;
</code></pre></div><p>可以看到，这里封装的组件可以处理两种情况，一种是传进来url，另一种是传进来裸html。基本的思路是等iframe加载完成之后，计算一下里面的高度和宽度，然后相应地设置iframe的大小。</p>
<p>用法：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vue" data-lang="vue">&lt;<span style="color:#062873;font-weight:bold">vue-iframe</span> <span style="color:#4070a0">url</span><span style="color:#666">=</span><span style="color:#4070a0">&#34;xxx&#34;</span>&gt;<span style="color:#666">&lt;</span><span style="">/vue-iframe&gt;</span>

&lt;<span style="color:#062873;font-weight:bold">vue-iframe</span> <span style="color:#4070a0">raw_html</span><span style="color:#666">=</span><span style="color:#4070a0">&#34;&lt;html&gt;...&lt;/html&gt;&#34;</span>&gt;<span style="color:#666">&lt;</span><span style="">/vue-iframe&gt;</span>
</code></pre></div><p>可以看到，使用是非常简单的。简单，但有效。</p>
<p>最后就是这个方法的缺点，那就是加载的url必须是同源的，否则获取不到内容的大小。</p>
<p>不过由于需求是显示裸html string，这个缺点问题不大。</p>
    </div>

    
        <div class="tags">
            
                <a href="https://fatjing.github.io/tags/iframe">iframe&#39;</a>
            
                <a href="https://fatjing.github.io/tags/vue">vue</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <p class="copyright">
    
       © Copyright 
       2021 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       
    
    </p>
    <p class="powerby">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

  </body>
</html>
